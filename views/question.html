<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問題</title>
    <link rel="stylesheet" href="/styles/question_style.css"> <!-- 外部CSSファイルを参照 -->
</head>
<body>
    <div id="questionContainer">
        <% if (questions.length > 0) { %>
            <div class="question">
                <p class="question_text" id="questionText"><%= questions[0].qText %></p>
            </div>
        <% } %>
    </div>

    <input type="text" id="answerInput">

    <!-- ボタンを囲むコンテナを追加 -->
    <div class="button-container">
        <button id="back_btn" class="back_btn">メニューに戻る</button>
        <button id="next_btn" class="next_btn">次の問題</button>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const questionContainer = document.getElementById('questionContainer');
        const questionText = document.getElementById('questionText');
        const answerInput = document.getElementById('answerInput');
        const nextBtn = document.getElementById('next_btn');
        const backBtn = document.getElementById('back_btn');

        // EJS で questions を JavaScript 配列に変換して渡す
        const questions = <%- JSON.stringify(questions) %>;
        console.log(questions); // ここで questions を確認

        let currentQuestionIndex = 0;
        let correctAnswers = 0;

        nextBtn.addEventListener('click', nextQuestion);
        answerInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleAnswer();
            }
        });

        backBtn.addEventListener('click', () => {
            window.location.href = '/'; // ページ1に遷移
        });


        function nextQuestion() {
            currentQuestionIndex++; // 次の問題へ進む

            if (currentQuestionIndex >= questions.length) {
                displayResult();
            } else {
                questionText.textContent = questions[currentQuestionIndex].qText;
            }
        }

        function displayResult() {
            questionContainer.style.display = 'none';
            const resultText = document.createElement('h1');
            resultText.textContent = "すべての問題が終了しました。";
            resultText.className = 'resultText'; // クラス名を設定
            document.body.appendChild(resultText);
            answerInput.style.display = 'none'; // 入力欄を非表示
            nextBtn.style.display = 'none'; // ボタンを非表示
            backBtn.style.display = 'none'; // 戻るボタンを非表示
            
            // 点数を表示
            const scoreElement = document.createElement('p');
            scoreElement.className = 'resultScore'; // クラス名を設定
            scoreElement.textContent = "`" + correctAnswers + "`" + "点です"; // 点数の表示
            document.body.appendChild(scoreElement);

            // もう一度ボタンを作成して表示
            const continueBtn = document.createElement('button');
            continueBtn.textContent = "もう一度";
            continueBtn.className = "continue_btn"; // スタイル用のクラスを追加
            continueBtn.addEventListener('click', () => {
                resetQuiz(); // クイズをリセット
            });
            document.body.appendChild(continueBtn);

            // 戻るボタンを作成して表示
            const resultBackBtn = document.createElement('button');
            resultBackBtn.textContent = "メニューに戻る";
            resultBackBtn.className = "result_back_btn"; // スタイル用のクラスを追加
            resultBackBtn.addEventListener('click', () => {
                window.location.href = '/'; // ページ1に遷移
            });
            document.body.appendChild(resultBackBtn);
        }

        function resetQuiz() {
            // 状態をリセット
            currentQuestionIndex = 0;
            correctAnswers = 0;
            answerInput.value = ''; // 入力欄をクリア
            questionContainer.style.display = 'block'; // 問題表示エリアを再表示
            questionText.textContent = questions[currentQuestionIndex].qText; // 最初の問題を表示

            // 追加した要素をクリアする
            const resultElements = document.querySelectorAll('.resultText, .resultScore, .continue_btn, .result_back_btn');
            resultElements.forEach(element => element.remove());

            nextBtn.style.display = 'block'; // 次の問題ボタンを再表示
            backBtn.style.display = 'block'; // 戻るボタンを再表示
        }

        function handleAnswer() {
            const userAnswer = answerInput.value.trim(); // ここでトリムを使用

            // 正しい答えを確認する
            if (userAnswer === String(questions[currentQuestionIndex].qAnswer).trim()) {
                correctAnswers += 20;
                alert("正解です");
            } else {
                alert("間違った答えです");
            }

            answerInput.value = ''; // 入力欄をクリア

            // 次の問題があれば表示
            nextQuestion();
        }
    });
</script>
</body>
</html>
